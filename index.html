<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuni's LoL Spell Manager (Riot API)</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background-color: #1a1a1a; color: #ffffff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background-color: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 10px; }
        
        /* Í≤ÄÏÉâÏ∞Ω Ïä§ÌÉÄÏùº */
        .search-box { margin-bottom: 10px; display: flex; gap: 8px; justify-content: center; padding: 10px; background: #333; border-radius: 8px; }
        .search-box input { padding: 6px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; font-size: 0.9rem; }
        .search-btn { padding: 6px 15px; background: #00ffcc; color: #1a1a1a; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 15px; background-color: #333; padding: 10px; border-radius: 8px; min-width: 650px; }
        .right-aligned-group { display: flex; align-items: center; gap: 20px; margin-left: auto; }
        .selectors-group { display: flex; gap: 5px; }
        .spell-selector, .boost-selector { background-color: #222; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 5px; font-size: 0.85rem; cursor: pointer; }
        .spell-selector { width: 90px; } .boost-selector { width: 110px; }
        .timer-unit { display: flex; align-items: center; gap: 8px; }
        .time-display { font-size: 1.5rem; font-weight: bold; width: 55px; text-align: center; color: #00ffcc; }
        button { width: 44px; height: 44px; padding: 0; cursor: pointer; background-color: #444; border: 2px solid #666; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; transition: border-color 0.3s; }
        button img { width: 100%; height: 100%; object-fit: cover; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-box">
            <input type="text" id="summoner-name" placeholder="ÏÜåÌôòÏÇ¨Î™Ö" style="width: 120px;">
            <input type="text" id="tag-line" placeholder="KR1" style="width: 60px;">
            <button class="search-btn" onclick="fetchGameInfo()">Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞</button>
        </div>
        
        <div id="time-container"></div>
    </div>

    <script>
        const rowsCount = 5;
        let timeStates = Array.from({ length: 5 }, () => [0, 0, 0]);
        let intervals = Array.from({ length: 5 }, () => [null, null, null]);
        let spellDataMap = {};

        // ÎùºÏù¥Ïóá API IDÏôÄ ÌïúÍ∏Ä Î™ÖÏπ≠ Îß§Ìïë
        const riotSpellMap = { 21: "Î∞©Ïñ¥Îßâ", 1: "Ï†ïÌôî", 14: "Ï†êÌôî", 3: "ÌÉàÏßÑ", 4: "Ï†êÎ©∏", 6: "Ïú†Ï≤¥Ìôî", 7: "ÌöåÎ≥µ", 12: "ÏàúÍ∞ÑÏù¥Îèô" };
        const spellFileMap = { 'Ï†êÎ©∏': 'flash', 'Ïú†Ï≤¥Ìôî': 'ghost', 'ÌöåÎ≥µ': 'heal', 'ÌÉàÏßÑ': 'exhaust', 'Î∞©Ïñ¥Îßâ': 'barrier', 'Ï†êÌôî': 'ignite', 'Ï†ïÌôî': 'cleanse', 'ÏàúÍ∞ÑÏù¥Îèô': 'teleport' };
        const spellColorMap = { 'Ï†êÎ©∏': '#ffcc00', 'Ïú†Ï≤¥Ìôî': '#00ccff', 'ÌöåÎ≥µ': '#adff2f', 'ÌÉàÏßÑ': '#ff8c00', 'Î∞©Ïñ¥Îßâ': '#ffff00', 'Ï†ïÌôî': '#00ccff', 'Ï†êÌôî': '#ff4d4d', 'ÏàúÍ∞ÑÏù¥Îèô': '#9b4dff' };

        const container = document.getElementById('time-container');

        async function init() {
            try {
                const response = await fetch('data/SummonerSpellData.csv');
                if (!response.ok) throw new Error("CSV ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥!");
                const dataText = await response.text();
                const rows = dataText.split('\n').filter(r => r.trim() !== '').map(r => r.split(','));
                rows.forEach(row => {
                    const name = row[0].trim();
                    if (name && !name.includes('Í∞ÄÏÜç') && !name.includes('ÌÄòÏä§Ìä∏') && spellFileMap[name]) {
                        spellDataMap[name] = row;
                    }
                });
                createTimerGrid();
            } catch (e) { container.innerText = "Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®!"; console.error(e); }
        }

        // ÎùºÏù¥Ïóá API Ìò∏Ï∂ú Î∞è ÏûêÎèô ÏÑ∏ÌåÖ Ìï®Ïàò
        async function fetchGameInfo() {
            const name = document.getElementById('summoner-name').value;
            const tag = document.getElementById('tag-line').value;
            if (!name || !tag) { alert("ÏÜåÌôòÏÇ¨Î™ÖÍ≥º ÌÉúÍ∑∏Î•º ÏûÖÎ†•Ìï¥Ï§ò Ïò§Îπ†! ü•∫"); return; }

            try {
                const response = await fetch(`/api/get-summoner-spells?summonerName=${encodeURIComponent(name)}&tagLine=${encodeURIComponent(tag)}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Í≤ÄÏÉâÌïú ÏÜåÌôòÏÇ¨Í∞Ä ÏÜçÌïú ÌåÄÏùò Î∞òÎåÄ ÌåÄ(ÏÉÅÎåÄÎ∞©) Ï∞æÍ∏∞
                const myPuuid = data.puuid; 
                const myParticipant = data.participants.find(p => p.puuid === myPuuid || p.summonerName.includes(name));
                const enemyTeamId = myParticipant.teamId === 100 ? 200 : 100;
                const enemies = data.participants.filter(p => p.teamId === enemyTeamId);

                // ÏÉÅÎåÄÎ∞© 5Î™ÖÏùò Ïä§Ìé†ÏùÑ ÏàúÏÑúÎåÄÎ°ú ÎìúÎ°≠Î∞ïÏä§Ïóê Ï£ºÏûÖ
                enemies.forEach((enemy, idx) => {
                    if (idx < 5) {
                        const s1Name = riotSpellMap[enemy.spell1Id] || "Ï†êÎ©∏";
                        const s2Name = riotSpellMap[enemy.spell2Id] || "Ï†êÎ©∏";
                        
                        const s1Select = document.getElementById(`sel-${idx}-0`);
                        const s2Select = document.getElementById(`sel-${idx}-1`);
                        
                        if (s1Select && s2Select) {
                            s1Select.value = s1Name;
                            s2Select.value = s2Name;
                            s1Select.dispatchEvent(new Event('change'));
                        }
                    }
                });
                alert("ÏÉÅÎåÄÎ∞© Ïä§Ìé† ÎèôÍ∏∞Ìôî ÏôÑÎ£å! üî•");
            } catch (e) { alert("Í≤åÏûÑ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏñ¥. (ÎßåÎ£åÎêú ÌÇ§ ÌòπÏùÄ ÏûòÎ™ªÎêú ÎãâÎÑ§ÏûÑ)"); }
        }

        function startTimer(r, s, sec, displayId) {
            if (intervals[r][s]) clearInterval(intervals[r][s]);
            timeStates[r][s] = sec;
            const display = document.getElementById(displayId);
            display.innerText = sec.toString().padStart(3, '0');
            intervals[r][s] = setInterval(() => {
                if (timeStates[r][s] > 0) {
                    timeStates[r][s]--;
                    display.innerText = timeStates[r][s].toString().padStart(3, '0');
                } else {
                    clearInterval(intervals[r][s]);
                    intervals[r][s] = null;
                }
            }, 1000);
        }

        function createTimerGrid() {
            container.innerHTML = '';
            for (let i = 0; i < rowsCount; i++) {
                const row = document.createElement('div');
                row.className = 'row';
                const selectors = document.createElement('div');
                selectors.className = 'selectors-group';
                const rightGroup = document.createElement('div');
                rightGroup.className = 'right-aligned-group';

                let def1 = (i === 0 || i === 2) ? 'ÏàúÍ∞ÑÏù¥Îèô' : (i === 3 ? 'Î∞©Ïñ¥Îßâ' : (i === 4 ? 'ÌöåÎ≥µ' : 'Ï†êÎ©∏'));
                const boost = document.createElement('select');
                boost.className = 'boost-selector';
                const opts = i === 2 ? [['2','Í∏∞Î≥∏'],['3','Ïã†Î∞ú'],['5','ÎØ∏Ïû•'],['6','Ïã†+Ïö∞'],['7','ÎØ∏+Ïö∞']] : [['2','Í∏∞Î≥∏'],['3','Ïã†Î∞ú'],['4','Ïö∞ÌÜµ'],['6','Ïã†+Ïö∞']];
                opts.forEach(o => { const opt = document.createElement('option'); opt.value = o[0]; opt.innerText = o[1]; boost.appendChild(opt); });

                if (i === 1) {
                    selectors.appendChild(boost);
                    rightGroup.appendChild(createTimerUnit(i, 1));
                    row.append(selectors, rightGroup);
                    const upd = () => updateBtn(i, 1, 'Ï†êÎ©∏', boost.value);
                    boost.onchange = upd; setTimeout(upd, 0);
                } else {
                    const s1 = createSelect(def1, i, 0);
                    const s2 = createSelect('Ï†êÎ©∏', i, 1);
                    selectors.append(s1, s2, boost);

                    if (i === 0) {
                        const unit7 = document.createElement('div');
                        unit7.className = 'timer-unit';
                        unit7.innerHTML = `<span class="time-display" id="time-0-tp7">000</span><button style="border-color: #9b4dff" onclick="startTimer(0, 2, 420, 'time-0-tp7')"><img src="images/teleport.png"></button>`;
                        rightGroup.append(unit7, createTimerUnit(i, 0), createTimerUnit(i, 1));
                    } else {
                        rightGroup.append(createTimerUnit(i, 0), createTimerUnit(i, 1));
                    }
                    row.append(selectors, rightGroup);
                    const upd = () => { updateBtn(i, 0, s1.value, boost.value); updateBtn(i, 1, s2.value, boost.value); };
                    s1.onchange = s2.onchange = boost.onchange = upd; setTimeout(upd, 0);
                }
                container.appendChild(row);
            }
        }

        function createSelect(def, r, s) {
            const sel = document.createElement('select');
            sel.className = 'spell-selector';
            sel.id = `sel-${r}-${s}`; // API ÎèôÍ∏∞ÌôîÎ•º ÏúÑÌïú ID Î∂ÄÏó¨
            Object.keys(spellDataMap).forEach(name => {
                const opt = document.createElement('option'); opt.value = name; opt.innerText = name;
                if (name === def) opt.selected = true;
                sel.appendChild(opt);
            });
            return sel;
        }

        function createTimerUnit(r, s) {
            const div = document.createElement('div');
            div.className = 'timer-unit';
            div.innerHTML = `<span class="time-display" id="time-${r}-${s}">000</span><div id="btn-box-${r}-${s}"></div>`;
            return div;
        }

        function updateBtn(r, s, name, bIdx) {
            const box = document.getElementById(`btn-box-${r}-${s}`);
            if (!box || !spellDataMap[name]) return;
            box.innerHTML = '';
            const sec = parseInt(spellDataMap[name][bIdx]);
            const btn = document.createElement('button');
            btn.style.borderColor = spellColorMap[name] || '#666'; 
            btn.innerHTML = `<img src="images/${spellFileMap[name]}.png">`;
            btn.onclick = () => startTimer(r, s, sec, `time-${r}-${s}`);
            box.appendChild(btn);
        }
        init();
    </script>
</body>
</html>
